<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fluffy Pancake Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f4f1ea; /* Creamy background */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #ui-layer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none; /* Let clicks pass through to canvas */
            color: #5d4037;
            opacity: 0.8;
            transition: opacity 0.5s;
        }

        .status-pill {
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f4f1ea;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0c097;
            border-top: 4px solid #8d6e63;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="status-text" class="status-pill">Loading Fluffy Pancakes...</div>
    </div>

    <!-- Import Map for Three.js and TWEEN -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@tweenjs/tween.js": "https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.esm.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        // Fix: Use "import * as TWEEN" to capture all named exports
        import * as TWEEN from '@tweenjs/tween.js';

        // --- Configuration ---
        const MODEL_PATH = './model.glb';
        
        // --- Scene Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color('#f4f1ea'); // Matches CSS background
        // Add some subtle fog for depth
        scene.fog = new THREE.Fog('#f4f1ea', 5, 15);

        // --- Camera ---
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 2, 4); // Positioned to look slightly down

        // --- Renderer ---
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimize for mobile
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.SoftShadowMap;
        container.appendChild(renderer.domElement);

        // --- Controls (OrbitControls for rotation/zoom) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth rotation
        controls.dampingFactor = 0.05;
        controls.minDistance = 1;
        controls.maxDistance = 10;
        controls.target.set(0, 0, 0);

        // --- Lighting (Warm & Tasty) ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xfff0dd, 1.5);
        dirLight.position.set(2, 5, 3);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        // Fill light to soften shadows
        const fillLight = new THREE.PointLight(0xffeebb, 0.5);
        fillLight.position.set(-2, 1, -2);
        scene.add(fillLight);

        // --- Loading Manager ---
        const statusText = document.getElementById('status-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const manager = new THREE.LoadingManager();

        manager.onLoad = function ( ) {
            // Fade out loading screen
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        };

        // --- Load the Model ---
        const loader = new GLTFLoader(manager);
        let model;

        loader.load(
            MODEL_PATH,
            (gltf) => {
                model = gltf.scene;
                
                // Auto-center and scale model
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                
                // Reset position to center
                model.position.x += (model.position.x - center.x);
                model.position.y += (model.position.y - center.y);
                model.position.z += (model.position.z - center.z);
                
                // Scale if too big or too small
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim > 2 || maxDim < 0.5) {
                    const scale = 1.5 / maxDim;
                    model.scale.set(scale, scale, scale);
                }

                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                scene.add(model);
                statusText.innerText = "Drag to rotate your pancakes!";
                
                // Animate entry
                model.rotation.y = Math.PI; 
                new TWEEN.Tween(model.rotation)
                    .to({y: 0}, 1000)
                    .easing(TWEEN.Easing.Quadratic.Out)
                    .start();
            },
            undefined, // onProgress
            (error) => {
                console.warn("Could not load model.glb. Showing fallback model.", error);
                createFallbackPancakes();
                statusText.innerText = "Model file not found. Showing placeholder.";
            }
        );

        // --- Fallback Procedural Pancake Generator ---
        // Runs if the .glb file isn't found so the user still sees something cool
        function createFallbackPancakes() {
            const pancakeGroup = new THREE.Group();
            
            // Pancake material
            const pancakeMat = new THREE.MeshStandardMaterial({ 
                color: 0xEebb88, 
                roughness: 0.6,
                metalness: 0.1
            });
            
            // Butter material
            const butterMat = new THREE.MeshStandardMaterial({
                color: 0xFFEB3B,
                roughness: 0.2
            });

            // Create 3 pancakes
            for(let i=0; i<3; i++) {
                const geometry = new THREE.CylinderGeometry(1, 1, 0.2, 32);
                const pancake = new THREE.Mesh(geometry, pancakeMat);
                pancake.position.y = i * 0.22;
                // Add some irregularity
                pancake.rotation.z = (Math.random() - 0.5) * 0.1;
                pancake.rotation.x = (Math.random() - 0.5) * 0.1;
                pancake.castShadow = true;
                pancake.receiveShadow = true;
                pancakeGroup.add(pancake);
            }

            // Add Butter
            const butterGeo = new THREE.BoxGeometry(0.4, 0.2, 0.4);
            const butter = new THREE.Mesh(butterGeo, butterMat);
            butter.position.y = 0.75;
            butter.rotation.y = Math.PI / 4;
            butter.castShadow = true;
            pancakeGroup.add(butter);

            // Add Plate
            const plateGeo = new THREE.CylinderGeometry(1.5, 1.3, 0.05, 32);
            const plateMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            const plate = new THREE.Mesh(plateGeo, plateMat);
            plate.position.y = -0.15;
            plate.receiveShadow = true;
            pancakeGroup.add(plate);

            scene.add(pancakeGroup);
            model = pancakeGroup; // Assign to model variable for animation
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            if (TWEEN) TWEEN.update(); // Update Tween animations
            controls.update(); // Required if damping is enabled
            renderer.render(scene, camera);
        }

        // --- Resize Handler ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start loop
        animate();

    </script>
</body>
</html>
